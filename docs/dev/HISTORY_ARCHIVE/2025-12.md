# Project History

This document tracks the evolution of the project, recording **what** changed, **why** it was changed, and **how** issues were resolved. Use this as context for future development.

## 2025-12-15: Robustness Improvements & Testing Infrastructure

### Context

User reported issues with broken internal links, missing images, and desired a more robust testing strategy.

### Changes

- **Refactor**: Modularized `Converter.js` into smaller internal methods (`_injectAnchors`, `_configureTurndown`, etc.).
- **Fix (Link Rewriting)**:
    - Previously, injecting anchors inside `<a>` tags caused invalid HTML nesting, resulting in broken Markdown links (e.g., `[](#id)`).
    - **Solution**: Changed logic to handle `<a>` tags separately in Turndown rules, ensuring IDs are preserved as sibling anchors or preserved attributes. Strict regex validation added to tests.
- **Testing**:
    - Replaced static `test.epub` with a dynamic generator (`generate_test_epub.js` using `epub-gen`).
    - Created `test/converter.test.js` covering:
        - Frontmatter generation
        - ATX Header styling
        - Image extraction (collision avoidance & `.jpeg` extension handling)
        - Internal link rewriting (including footnotes)
        - Formatting (Lists, Fenced Code, Bold/Italic, Blockquotes)
- **Documentation**: Added `ARCHITECTURE.md` and updated `README.md` to reflect current capabilities.

### Lessons Learned

- **Test Quality**: Simple `toContain` checks are insufficient for Markdown link verification. Tests must use regex to verify the syntax `[text](url)` is intact.
- **EPUB Variability**: Different libraries (`nodepub` vs `epub-gen`) produce slightly different HTML structures. The converter must be robust against these variations.

---

## 2025-12-15: Obsidian Native Links & Footnotes

### Context

Users reported that internal links generated by the tool didn't work in Obsidian. The previous approach used HTML anchors (`<a id="...">`), which Obsidian doesn't recognize for internal linking.

### Implementation Evolution

#### Phase 1: Block ID Approach (PR #4, #5)

- **Change**: Replaced HTML anchors with Obsidian Block IDs (`^id`)
- **Links**: `[[#^id|text]]` format
- **Footnotes**: Native `[^id]` syntax
- **Tests**: Added strict negative assertions to prevent HTML/Markdown links

#### Phase 2: Heading-Text Approach (CODEX Enhancement + PR #6)

- **Change**: Switched to heading-text-based linking (Obsidian's native behavior)
- **Links**: `[[#Heading Text|link text]]` instead of `[[#^id|text]]`
- **Implementation**:
    - `_preindexHeadingText()`: Pre-scans chapters to build ID→heading text map
    - `_preprocessAnchors()`: Hoists standalone anchors onto headings
    - Converts chapter title paragraphs to proper headings
- **Fixes Applied**:
    - Image spacing: Added `\n\n` around images to prevent merging with headings
    - Footnote back-link removal: Updated regex to handle both Block ID and heading-text formats

### Technical Details

**Anchor Preprocessing**:

```javascript
// Before: <a id="intro"></a><h1>Introduction</h1>
// After:  <h1 id="intro">Introduction</h1>
```

**Link Resolution**:

```javascript
// href="#intro" → lookup headingTextMap["intro"] → "Introduction"
// Output: [[#Introduction|link text]]
```

**Footnotes**:

- Reference: `<a href="#note1">[1]</a>` → `[^note1]`
- Definition: `<p id="note1">[1] Content</p>` → `[^note1]: Content`

### Lessons Learned

- **Obsidian Compatibility**: Block IDs work but heading-text links are more natural and maintainable
- **Image Spacing**: Turndown doesn't add spacing around block-level replacements; must be explicit
- **Regex Flexibility**: Back-link removal must handle multiple formats (Block ID, heading-text, various symbols)
- **Test Coverage**: Need both positive (feature works) and negative (old formats don't appear) assertions
- **Documentation**: Implementation artifacts (walkthrough.md, implementation_plan.md) are critical for context preservation across sessions
